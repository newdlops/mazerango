<!-- mazerango -->
{% load i18n mazerango_field mazerango_admin_list static %}
{% if result_hidden_fields %}
  <div class="hiddenfields">{# DIV for HTML validation
  {% for item in result_hidden_fields %}{{ item }}{% endfor %}
  </div>
{% endif %}

<table class="mazerango-changelist" id="mazerango-changelist">
  <thead>
  <tr>
    {% for header in result_headers %}
      <th>{{ header.text|capfirst }}</th>
    {% endfor %}
  </tr>
  </thead>
  <tbody>
  {% for result in results %}
    {% if result.form and result.form.non_field_errors %}
      <tr><td colspan="{{ result|length }}">{{ result.form.non_field_errors }}</td></tr>
    {% endif %}
    <tr>{% for item in result %}{{ item }}{% endfor %}</tr>
  {% endfor %}
  </tbody>
</table>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        new DataTable('#mazerango-changelist', {
            responsive: true,
            ajax: {
                url: 'ajax/',
                dataSrc: 'data',
                data: function (json) {
                    console.log(json);
                    var length = json.length
                    var start = json.start
                    var order = json.order.reduce((a, c , i)=>{
                        return (c.dir=='desc'?'-':'')+c.column
                    },"")
                    return {o: order, len: length, p: parseInt(start / length) + 1 };
                },
                dataFilter: function(data){
                    var json = jQuery.parseJSON( data );
                    var result = jQuery.parseJSON( json.data );
                    return JSON.stringify({data:result}); // return JSON string
                },
            },
            serverSide: true,
            columnDefs: [
                {% for field in cl.list_display %}
                    {% if forloop.first %}
                        {
                            // The `data` parameter refers to the data for the cell (defined by the
                            // `data` option, which defaults to the column being worked with, in
                            // this case `data: 0`.
                            render: (data, type, row) => {
                                return `<input type="checkbox" name="_selected_action" value="${row.id}" class="action-select" aria-label="Select this object for an action - ${row.user_id}">`
                            },
                            targets: 0
                        },
                    {% else %}
                        {
                            render: (data, type, row) => {
                                {% if field in cl.list_display_links %}
                                  return `<a href="/admin/{{ cl.opts.app_label }}/{{ cl.opts.model_name }}/${row.id}/change/"><span class="font-bold">${data}</span></a>`
                                {% else %}
                                  return data;
                                {% endif %}
                            },
                            targets: {{ forloop.counter0 }}
                        },
                    {% endif %}
                {% endfor %}
            ],
            columns: [
            {% for field in cl.list_display %}
                {% if forloop.first %}
                  { data: null },
                {% else %}
                  { data: '{{ field }}' },
                {% endif %}
            {% endfor %}
        ]
        });
    });
</script>

